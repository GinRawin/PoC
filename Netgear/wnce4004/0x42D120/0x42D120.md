# Overview

- Manufacturer's website information：https://www.netgear.com/
- Firmware download address ：https://www.netgear.com/support/download/?model=WNCE4004

# Affected version

WNCE4004 1.0.0.34 and before

# Vulnerability description

A buffer overflow exists in the NETGEAR WNCE4004 router (firmware V1.0.0.34 and before).By accessing the `lan` page, users can pass the payload to the `lan_ipaddr` configuration item through the `ether_ipaddr` parameter, which will cause a bugger overflow when accessing the page `SetIPInterfaceInfo`. As a result, an attacker could cause a denial of service or potentially remote code execution.

# Vulnerability location

The call to strcpy at address `0x42D120` in the function `sub_42CE44`. 

# Vulnerability Reproduction Steps

Environment :

Verification was conducted through simulation. The rehost environment is [wnce4004rehosted.tar.gz](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/wnce4004rehosted.tar.gz). This is a simulation result based on [Greenhouse](https://github.com/sefcom/greenhouse).The operating system used for reproduction is Ubuntu 22 (other environments that can use docker-compose should also work).

Reproduction steps:

1. Navigate to the debug directory in the simulation environment and start the rehost environment using the commands `docker-compose build` and `docker-compose up`.

2. Trigger the vulnerability by sending packages. I have attached the package sending script [send.py](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/send.py) and data packages [package1.raw](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/0x42D120/package1.raw), [package2.raw](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/0x42D120/package2.raw),[package3.raw](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/0x42D120/package3.raw). The usage is `python3 send.py xxx`. If there are multiple data packages input, repeat this step to send multiple data packages.

For detailed reproduction instructions, please refer to my attached [video](https://github.com/GinRawin/PoC/blob/main/Netgear/wnce4004/0x42D120/DemonstrationProcess.mp4)

# Vulnerability Details

1. 发送第一个数据包，设置`submit_flag=lan`进入函数`sub_40AC4C`，设置`change_wan_type=0`从而程序调用函数`do_setting`，根据`off_45713C`内容，提取包中`ether_ipaddr`的值为`lan_ipaddr`的值。

![alt text](image.png)

![alt text](image-1.png)

2. 发送第二个数据包，在`SOAPAction`中，设置参数`DeviceConfig:#ConfigurationStarted`会进入函数`ExecuteSoapAction`，进而根据`off_458190`调用函数`sub_42ACB4`，将`config_state`的值设置为1

![alt text](image-2.png)

![alt text](image-3.png)

![alt text](image-4.png)

![alt text](image-5.png)

3. 发送第三个数据包，在`SOAPAction`中，设置参数`WANIPConnection:#SetIPInterfaceInfo`会进入函数`ExecuteSoapAction`，进而根据`off_458430`调用函数`sub_42CE44`，由于`config_state`的值为1，因此程序能够运行到`0x42D120`位置，将`lan_ipaddr`的值传播到`sprintf`函数

![alt text](image-6.png)
